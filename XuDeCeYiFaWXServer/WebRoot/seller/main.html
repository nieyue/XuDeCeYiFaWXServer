<!DOCTYPE html>
<html>
<head>
		<title>新闻后台管理系统</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
	<meta name="Keywords" content="系统，管理"/>
	 <link href="/resources/css/bootstrap.min.css" rel="stylesheet">
     <link href="/resources/css/sellerbase.css" rel="stylesheet">
	
    
</head>
   <body ng-app="mainApp" ng-controller="mainCtrl">
  	<div ui-view></div>
<!-- 按钮触发模态框 -->
<button class="hide" data-toggle="modal" 
   data-target="#myModal" id="mySellerModal">
</button>
	<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" 
   aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog" >
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" 
               data-dismiss="modal" aria-hidden="true" id="closeModal">
                  &times;
            </button>
            <h4 class="modal-title" id="mySellerModalLabel">
            </h4>
         </div>
         <div class="modal-body" id="mySellerModalBody">
         </div>
         <div class="modal-footer">
         	<div id="errorSellerInfo" class="text-justify text-danger"></div>
            <button type="button" class="btn btn-primary" id="sellerSubmit">
               提交
            </button>
         </div>
      </div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->
</div><!-- /.modal -->
		<script src="/resources/js/jquery2.1.js"></script>
		<script src="/resources/js/bootstrap3.2.0.js"></script>
		<script src="/resources/js/angularjs.min.1.5.7.js"></script>
		<script src="/resources/js/angular-animate.min.js"></script>
		<script src="/resources/js/angular-ui-router.min.js"></script>
        <script src="/resources/js/sortable.min.js"></script>
       <script src="/resources/js/base64.js"></script> 
       <script src="/resources/js/base.js"></script> 
       <script type="text/javascript">
       
       angular.module('mainApp', ['ngAnimate','ui.router'])
       .config(function ($stateProvider, $urlRouterProvider) {
     	$urlRouterProvider.when("", "main");
     	$stateProvider
     	.state("main", {
            url: "/main",
            views: {
                '': {
                    templateUrl: '/seller/templates/main.html'
                },
                'topbar@main': {
                    templateUrl: '/seller/templates/topbar.html'
                },
                'leftbar@main': {
                    templateUrl: '/seller/templates/leftbar.html',
                    controller:function(){
                    	myUtils.myClickRotate("a.toCaret","span.caret");//箭头旋转
                    }
                } ,
                'rightbody@main': {
                    templateUrl: '/seller/templates/notice.html'
                } 
            }
        })
         .state("main.notice", {
            url:"/notice",
            views: {
            	'rightbody@main': {
                    templateUrl: "/seller/templates/notice.html"
                } 
            }
        })
        .state("main.testList", {
            url:"/testList",
            views: {
            	'rightbody@main': {
                    templateUrl: "/seller/templates/news_list.html"
                	,controller:function($scope){
                		//新闻列表
                   		function initData(a){
                			$.ajax({  
                		          type : "get",  
                		          url : "/news/list?pageNum="+a.pageNum+"&pageSize="+a.pageSize+"&type="+a.type+"&orderName="+a.orderName+"&orderWay="+a.orderWay+"",  
                		          async : false,  
                		          success : function(data){
                		        	  if(data==''){
                		        		  $("#addMore").hide();
                		        		  return ;
                		        	  }else{
                		        		  $("#addMore").show();
                		        		  
                		        	  }
                		        	  if(a.pageNum>1){
                		        		  for (var int = 0; int < data.length; int++) {
                		        			$scope.newsList.push(data[int]); 
                						}
                		        	  }else{
                		        	  $scope.newsList=data; 
                		        		  
                		        	  } 
                		        	  myUtils.myPrevToast("加载完成", null, "remove");
                		          }  
                		          });  
                		}
                   		//初始化
                		initData({
                			pageNum:1,
                			pageSize:10,
                			type:"首页",
                			orderName:"news_id",
                			orderWay:"desc"
                			});	
                   		//全部新闻列表
                   		$scope.allNews=function(){
                   			initData({
                    			pageNum:1,
                    			pageSize:10,
                    			type:"首页",
                    			orderName:"news_id",
                    			orderWay:"desc"
                    			});	
                   			$("#addMore").show();//显示加载
                   		};
                   		//热门置顶新闻列表
                   		$scope.fixedRecommendNews=function(){
                   		//热门置顶
          		        	$.ajax({  
              		          type : "get",  
              		          url : "/news/list/random/fixedRecommend?pageSize=3",  
              		          async : false,  
              		          success : function(data){
              		        	 $scope.newsList=data; 
              		        	$("#addMore").hide();//隐藏加载
              		        	  myUtils.myPrevToast("加载完成", null, "remove");
              		          }  
              		          }); 
            				
                   		};
                   		//推荐新闻列表
                   		$scope.isRecommendNews=function(){
                   		//推荐
            				$.ajax({  
              		          type : "get",  
              		          url : "/news/list/random/isRecommend?pageSize=5",  
              		          async : false,  
              		          success : function(data){
              		        	 $scope.newsList=data; 
              		        	$("#addMore").hide();//隐藏加载
              		        	  myUtils.myPrevToast("加载完成", null, "remove");
              		          }  
              		          });  
                   		};
                   		//介绍
                   		$scope.listType=function(typeName){
                   			initData({
                    			pageNum:1,
                    			pageSize:10,
                    			type:typeName,
                    			orderName:"time",
                    			orderWay:"desc"
                    			});	
                   			$("#addMore").show();//显示加载
                   		};
                   		
                   		/* $scope.$watch("newsList",function(){
                   			console.log($scope.newsList)
                   			if($scope.newsList[0].is_recommend=="1" || $scope.newsList[0].fixed_recommend=="1"){
                   				$("#addMore").hide();
                   			}else{}
                   		}); */
                   		//获取更多
                		$scope.addMore=function(){
                			$("#addMore").children().text("正在加载中...");
                			var pageNum=$(".listGroup").size()+1;
                			var type=$(".nav-active div").text().trim();
                			
                			initData({
                    			pageNum:pageNum,
                    			pageSize:10,
                    			type:type,
                    			orderName:"news_id",
                    			orderWay:"desc"
                    			});
                						
                			$("#addMore").children().text("点击加载更多》");
                		}; 
                		//修改new
                		$scope.updateNew=function(news){
                			$("#mySellerModal").unbind().click();
                			$("#mySellerModalLabel").html("修改新闻");
                			$("#mySellerModalBody").parent().css("width","900px");
                			$("#mySellerModalBody").html(
                					"<form>"+
									" <label for='updateNewsTitle' class='text-danger'>※新闻标题（必填）</label>"+
									" 	<div class='comment-input-margin'>"+
									" 	<input type='text' class=' comment-input' id='updateNewsTitle'  placeholder='输入新闻标题'>"+
									" </div>"+
									"  <label for='updateNewsType' class='text-danger'>※新闻类型（必填）</label>"+
									"<div class='comment-input-margin '>"+
									"   <input type='text' class='comment-input' id='updateNewsType'  placeholder='输入新闻类型'>"+
									" </div>"+
									 "<label  class='text-danger'>※是否置顶，默认否</label>"+
									  "<div class='comment-input-margin '>"+
									    "<input type='radio' name='radioFixedRecommend' class='disableFixedRecommend' value='0'/>否"+
										"<input type='radio' name='radioFixedRecommend' class='disableFixedRecommend' value='1'/>是<br>"+
									 " </div>"+
									   " <label  class='text-danger'>※是否热门推荐，默认否</label>"+
									 "<div class='comment-input-margin '>"+
									   " <input type='radio' name='radioIsRecommend' class='disableIsRecommend' value='0'/>否"+
										"<input type='radio' name='radioIsRecommend' class='disableIsRecommend' value='1'/>是<br>"+
									 " </div>"+
									"  <label for='updateNewsContent' class='text-danger'>※新闻内容（必填）</label>"+
								    " <div class='comment-input-margin'>"+
									"  <script id='editor2' type='text/plain' style='width:800px;z-index:10000'><//script>"+
									"</div>"+
									"</form>");
                			//增加富文本编辑器初始化
                     	   	UE.delEditor('editor2');//删除获取实例
        
                 			var	ue = UE.getEditor('editor2');//获取实例，有就得到，没有就创建
                 			function initForm(){
                 				$.get("/news/"+news.news_id,function(data){
                 					console.log(data)
                 					$("#updateNewsTitle").val(data.title);
                 					$("#updateNewsType").val(data.type);
                 					
                 						console.log(data)
                 						//初始化禁用双选
                 						function initDisableRecommend(_this,element){
                 							if($(_this).val()=="1"){
                 								$(element).prop("disabled","true");
                 							}else{
                 								$(element).prop("disabled","");
                 							}
                 						}
                 						
                 						$("input[name='radioFixedRecommend']").each(function(){
                 						
                 						if(data.fixed_recommend==$(this).val()){
                 						$(this).prop("checked","checked"); 
                 						initDisableRecommend(this,"input[name='radioIsRecommend']");
                 						}
                 						if(!data.fixed_recommend){
                 							$("input[name='radioFixedRecommend']").eq(0).prop("checked","checked"); 
                 							
                 						}
                 						
                 						$(this).on("change",function(){
                 						initDisableRecommend(this,"input[name='radioIsRecommend']");
                 						});
                 						});
                 						
                 						$("input[name='radioIsRecommend']").each(function(){
                 						if(data.is_recommend==$(this).val()){
                 						$(this).prop("checked","checked"); 
                 						initDisableRecommend(this,"input[name='radioFixedRecommend']");
                 						}
                 						if(!data.is_recommend){
                 							$("input[name='radioIsRecommend']").eq(0).prop("checked","checked"); 
                 							
                 						}
                 						
                 						$(this).on("change",function(){
                 							initDisableRecommend(this,"input[name='radioFixedRecommend']");
                 						});
                 						});
                 					ue.ready(function(){
                 					ue.setContent(data.content);
                 					});
                 					
                 				});
                 			}
                 			initForm();
                 			//提交更新表单
                 			console.log(ue)
                 			$("#sellerSubmit").unbind().click(function(){
                 				var news_id=news.news_id;
                 				var title=$("#updateNewsTitle").val().trim();
                        		var type=$("#updateNewsType").val().trim();
                        		var radioFixedRecommend=$("input[name='radioFixedRecommend']:checked").val();
                        		var radioIsRecommend=$("input[name='radioIsRecommend']:checked").val();
                        		var img_address=news.img_address;
                        		var content=ue.getContent();
                 					
                        		console.log(radioFixedRecommend)
                        		myUtils.myPrevToast("修改中", function(){
                        		$.ajax({  
                  		          type : "post",  
                  		          url : "/news/update",  
                  		          data:{"news_id":news_id,"title":title,"type":type,
                  		        	  "fixed_recommend":radioFixedRecommend,
                  		        	  "is_recommend":radioIsRecommend,
                  		        	  "img_address":img_address,"content":content},
                  		          async : true,  
                  		          success : function(data){
                  		        	if(data.code==200){
                  		   			$("#closeModal").click();
                  		        	  myUtils.myPrevToast("修改成功", null, "remove");
                  		   			//location.reload();
                  		   			$scope.newsList[$scope.newsList.indexOf(news)].title=title;
                  		   			$scope.newsList[$scope.newsList.indexOf(news)].type=type;
                  		   			$scope.newsList[$scope.newsList.indexOf(news)].img_address=img_address;
                  		   			$scope.newsList[$scope.newsList.indexOf(news)].time=myUtils.timeStampToDate(new Date());
                  		   			$scope.newsList[$scope.newsList.indexOf(news)].fixed_recommend=radioFixedRecommend;
                  		   			$scope.newsList[$scope.newsList.indexOf(news)].is_recommend=radioIsRecommend;
                  		   			$scope.newsList[$scope.newsList.indexOf(news)].content=content;
                  		   			$scope.$apply();
                  		   			/* $("#updateNewsTitle").val(title);
                 					$("#updateNewsType").val(type);
                 					ue.ready(function(){
                 					ue.setContent(content);
                 					}); */
                  		        	  return;
                  		        	  }
                  		        	  myUtils.myPrevToast("修改失败", null, "remove");
                  		          }  
                  		          });  
                        		}, "add");
                			});
                		};
                		//删除new
                		$scope.deleteNew=function(news){
                			myUtils.myLoginOut("确定删除吗？", function(){
                   				$.get("/news/"+news.news_id+"/delete",function(data){
                   					console.log($scope.newsList)
                   	   				if(data.code==200){
                   	   				$scope.newsList.splice($scope.newsList.indexOf(news), 1);
                   	   				//$scope.newsList.splice(news.news_id,1);
                   	   				$scope.$apply();
                   	   				myUtils.myLoadingToast("删除成功", null); 
                   	   				
                   	   				}else{
                   	   					myUtils.myLoadingToast("删除失败", null);   	   				
                   	   				}
                   	   			});
                   			});
                			
                		};
                		
                    }
            	} 
            }
        })
        .state("main.testAdd", {
            url:"/testAdd",
            views: {
            	'rightbody@main': {
                    templateUrl: "/seller/templates/news_add.html",
                    controller:function($scope){
                    	$scope.test={
                    		 test_id:'',
                    		 title:'',
                    		 type:'爱情测试',
                    		 level:'10',
                    		 img:'',
                    		 update_date:'',
                    		 problemList:[
                    		           {
                    		        	   problem_id:'',
                    		        	   name:'',
                    		        	   type:'',
                    		        	   img:'',
                    		        	   order_number:'',
                    		        	   update_date:'',
                    		        	   answerList:[
                    		        	               {
                    		        	            	   answer_id:'',  
                    		        	            	   name:'',  
                    		        	            	   type:'',  
                    		        	            	   img:'',  
                    		        	            	   result:'',  
                    		        	            	   update_date:''  
                    		        	               }]
                    		        	   
                    		           }]                    		 
                    	};
                    	
                    	//问题数目改变
                    	$scope.problemListChange=function(problemNumber){
                    		$scope.test.problemList=[];
                    		console.log(problemNumber)
                    		for (var i = 0; i < problemNumber; i++) {
                    			$scope.test.problemList.push({
                    			   problem_id:'',
             		        	   name:'',
             		        	   type:'',
             		        	   img:'',
             		        	   order_number:'',
             		        	   update_date:'',
             		        	  answerList:[
           		        	               {
           		        	            	   answer_id:'',  
           		        	            	   name:'',  
           		        	            	   type:'',  
           		        	            	   img:'',  
           		        	            	   result:'',  
           		        	            	   update_date:''  
           		        	               }]
	        	               });
    							}
                    	};
                    	//答案数目改变
                    	$scope.answerListChange=function(problem,answerNumber){
                    		for (var i = 0; i < $scope.test.problemList.length; i++) {
                    			//选择得当前问题
                    			if($scope.test.problemList[i]==problem){
                    			$scope.test.problemList[i].answerList=[];
                    			console.log(problem)
                    			console.log(answerNumber)
                    			for (var j = 0; j < answerNumber; j++) {
                    			console.log($scope.test.problemList[i].answerList)
                    			$scope.test.problemList[i].answerList.push({
                    				   answer_id:'',  
		        	            	   name:'',  
		        	            	   type:'',  
		        	            	   img:'',  
		        	            	   result:'',  
		        	            	   update_date:'',  
	        	               });
								}
                    			}
    						}
                    	};
                    	//上传测试图片
                 		$("#testFileUpload").change(function(){
                    		//console.log($("#testFileUpload"))
                 		//function testFileUpload(){
                 			myUtils.fileUpload(
                 				    {inputfile:$("#testFileUpload"),
                 				    ajaxObj:{
                 				        formData:[
                 				            {key:"testFileUpload",value:$("#testFileUpload").get(0).files[0]}
                 				            ],
                 				        url:"/test/img/add",
                 				        success:(data)=>{
                 				            if(data){
                 				            myUtils.myLoadingToast("上传成功",null);
                 				            myUtils.myPrevToast("上传成功",null,"remove");
                 				           $scope.test.img=data;
                 				           $scope.$apply();
                 				            }
                 				        }
                 				    }
                 				}
                 				);
                 		});
                     	    //提交表单
                    	$scope.addTestForm=function(){
                     	    	console.log(angular.toJson($scope.test));
                     	    	//return;
                    		myUtils.myPrevToast("添加中", function(){
                    		$.ajax({  
              		          url : "/test/add/all",  
              		          type : "post",  
              		         // contentType:"application/json",
              		          data:{testDTO:angular.toJson($scope.test)},
              		         // async : true,  
              		          success : function(data){
              		        	if(data.code==200){
              		        		$scope.test={
              	                    		 test_id:'',
              	                    		 title:'',
              	                    		 type:'爱情测试',
              	                    		 level:'10',
              	                    		 img:'',
              	                    		 update_date:'',
              	                    		 problemList:[
              	                    		           {
              	                    		        	   problem_id:'',
              	                    		        	   name:'',
              	                    		        	   type:'',
              	                    		        	   img:'',
              	                    		        	   order_number:'',
              	                    		        	   update_date:'',
              	                    		        	   answerList:[
              	                    		        	               {
              	                    		        	            	   answer_id:'',  
              	                    		        	            	   name:'',  
              	                    		        	            	   type:'',  
              	                    		        	            	   img:'',  
              	                    		        	            	   result:'',  
              	                    		        	            	   update_date:''  
              	                    		        	               }]
              	                    		        	   
              	                    		           }]                    		 
              	                    	};
              		        	  $scope.$apply();
              		        	  myUtils.myPrevToast("添加成功", null, "remove");
              		        	  return;
              		        	  }
              		        	  myUtils.myPrevToast("添加失败", null, "remove");
              		          }  
              		          });  
                    		}, "add");
             			};
                    }
                } 
            }
        });
		})
       .controller('mainCtrl', function($scope,$http) {
    	 //设置高度
    	 setInterval(function(){
			$(".seller-main-body").height($(".seller-main-body-right").height()+50);
    		 
    	 }, 300);
    	 //验证是否已经登录
    		$.get("/admin/islogin",function(data){
       			console.log(data)
       			//$scope.manager_phone=data.manager_phone;
       		if(data==null||data==''){
       			location.replace("/seller/index");
       		}
       	});
   		//登录退出
   		$scope.sellerLoginOut=function(){
   			myUtils.myLoginOut("确定退出吗？", function(){
   				$.get("/admin/loginout",function(data){
   	   					myUtils.myLoadingToast("退出成功", null);   	   				
   						location.replace("/seller/index");
   	   			});
   			});
   		};
   		
   		});			
     
		</script>
        </body>
</html>